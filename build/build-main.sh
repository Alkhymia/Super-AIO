#!/bin/bash

# 
# This file originates from Kite's Super AIO control board project.
# Author: Kite (Giles Burgess)
# 
# THIS HEADER MUST REMAIN WITH THIS FILE AT ALL TIMES
#
# This firmware is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This firmware is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this repo. If not, see <http://www.gnu.org/licenses/>.
#

if [ $# != 1 ] ; then
  echo "Usage: ./<cmd> <ORIGINAL.img>"
  exit 1
fi

#####################################################################
# Vars
BUILD="SAIO_"$(date +"%Y%m%d-%H%M%S")
INFILE=$1
GITHUB="https://github.com/geebles/Super-AIO"
GITHUBDIR="Super-AIO"
MOUNT="mnt"
PIHOMEDIR="$MOUNT/home/pi"
CRONRAW="# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (cronSAIO.txt installed on Sun Jan 15 17:10:21 2017)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
@reboot /usr/bin/nice -n 19 /usr/bin/python /home/pi/Super-AIO/release/saio/saio-osd.py
"

#####################################################################
# Functions
execute() { #STRING
  if [ $# != 1 ] ; then
    echo "ERROR: No args passed"
    exit 1
  fi
  cmd=$1
  
  echo "EXECUTE: [$cmd]"
  eval "$cmd"
  
  if [ $? != 0 ] ; then
    echo "ERROR: Command exited with [$?]"
    exit 1
  fi
  
  return 0
}

exists() { #FILE
  if [ $# != 1 ] ; then
    echo "ERROR: No args passed"
    exit 1
  fi
  
  file=$1
  
  if [ -f $file ]; then
    echo "FILE: [$file] exists."
    return 0
  else
    echo "FILE: [$file] does not exist."
    return 1
  fi
}

#####################################################################
# LOGIC!
echo "STARTING BUILD [$BUILD].."

# Sanity check INFILE
if ! exists $INFILE ; then
  echo "ERROR: INFILE [$INFILE] doesn't exist"
  exit 1
fi

OUTFILE=$(basename $INFILE .img)"_$BUILD.img"
ZIPFILE=$(basename $INFILE .img)"_$BUILD.zip"

# Sanity check OUTFILE
if exists $OUTFILE ; then
  echo "ERROR: OUTFILE [$OUTFILE] exists! Can't create new image"
  exit 1
fi

# Copy img to new + name
execute "cp $INFILE $OUTFILE"

# Clean github dirs
if [ -d $GITHUBDIR ] ; then
  execute "rm -rf $GITHUBDIR"
fi

# Checkout code
execute "git clone $GITHUB"

#####################################################################
# Mount img p1
execute "mount -o loop,offset=4194304 $OUTFILE $MOUNT"

# Copy required to p1
execute "cp $MOUNT/config.txt $MOUNT/config_ORIGINAL.txt"
execute "cp $GITHUBDIR/release/saio/config.txt $MOUNT/config.txt"
execute "cp $GITHUBDIR/release/saio/config-saio.txt $MOUNT/config-saio.txt"

# Unmount
execute "umount $MOUNT"

#####################################################################
# Mount img p2
execute "mount -o loop,offset=63963136 $OUTFILE $MOUNT"

# Copy required to p2
execute "cp -r $GITHUBDIR $PIHOMEDIR"
execute "chown -R giles:giles $PIHOMEDIR"
execute "cp $GITHUBDIR/release/saio/asound.conf $MOUNT/etc/asound.conf"

# Copy autostart
execute "mv $MOUNT/opt/retropie/configs/all/autostart.sh $MOUNT/opt/retropie/configs/all/autostart_OLD.sh"
execute "cp $GITHUBDIR/release/saio/autostart.sh $MOUNT/opt/retropie/configs/all/autostart.sh"
execute "chown giles:giles $MOUNT/opt/retropie/configs/all/autostart.sh"

# Copy cron
execute "echo '$CRONRAW' > $MOUNT/var/spool/cron/crontabs/pi"
execute "chmod 600 $MOUNT/var/spool/cron/crontabs/pi"
execute "chown giles:crontab $MOUNT/var/spool/cron/crontabs/pi"

# Chmod required in p2
execute "chmod +x $PIHOMEDIR/$GITHUBDIR/release/saio/osd/osd"
execute "chmod +x $PIHOMEDIR/$GITHUBDIR/release/saio/flash/flash.sh"
execute "chmod +x $PIHOMEDIR/$GITHUBDIR/release/tester/pngview"

# Install python-serial
execute "dpkg -x $GITHUBDIR/release/saio/python-serial_2.6-1.1_all.deb $GITHUBDIR/python-serial"
execute "cp -r $GITHUBDIR/python-serial/* $MOUNT"

# Fix splashsreen sound
execute "sed -i \"s/ *both/ alsa/\" $MOUNT/etc/init.d/asplashscreen"

# Unmount
execute "umount $MOUNT"

#####################################################################
# Zip
execute "zip $ZIPFILE $OUTFILE"

#####################################################################
# DONE
echo "DONE!"
